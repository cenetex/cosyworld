<!--
  Unified Settings (Global + Per-Guild Overrides)
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="/css/admin-common.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100">
    <div class="min-h-screen flex flex-col">
  <!-- Legacy nav (will be replaced by admin-shell.js) -->
  <nav class="bg-gray-800 text-white shadow-lg" data-legacy-nav>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <h1 class="text-xl font-bold">RATi Admin Panel</h1>
              </div>
              <div class="ml-10 flex items-baseline space-x-4">
                <a href="/admin" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700">Dashboard</a>
                <a href="/admin/avatar-management" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700">Avatar Management</a>
                <a href="/admin/collections" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700">Collections</a>
                <a href="/admin/settings" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-gray-700">Settings</a>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <main class="flex-grow">
        <div class="max-w-6xl mx-auto py-6 sm:px-6 lg:px-8">
          <div class="bg-white shadow sm:rounded-lg p-4">
            <div class="flex gap-6">
              <aside class="w-64">
                <div class="bg-gray-50 border rounded p-2">
                  <div class="flex items-center justify-between mb-2">
                    <div class="text-xs uppercase text-gray-500 px-1">Scope</div>
                    <a href="/admin/servers" id="detectedServersLink" class="text-[10px] text-indigo-600 hover:underline" title="View detected (unauthorized) servers">Detected<span id="detectedServersCount" class="ml-1 text-gray-500"></span></a>
                  </div>
                  <div id="guildList" class="flex flex-col gap-1"></div>
                </div>
              </aside>

              <section class="flex-1">
                <!-- Top header and actions -->
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <h2 class="text-lg font-semibold">Settings</h2>
                    <div class="ml-2 inline-flex rounded overflow-hidden border">
                      <button id="tabPrompts" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200">Prompts</button>
                      <button id="tabSettings" class="px-3 py-1 text-sm hover:bg-gray-100">Settings</button>
                      <button id="tabPayments" class="px-3 py-1 text-sm hover:bg-gray-100">Payments</button>
                      <button id="tabSecrets" class="px-3 py-1 text-sm hover:bg-gray-100">Secrets</button>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <input id="filterText" type="text" placeholder="Filter keys..." class="px-2 py-1 border rounded text-sm" />
                    <label class="text-sm text-gray-700 flex items-center gap-1"><input id="onlyOverrides" type="checkbox" /> Overrides only</label>
                    <button id="exportEnv" class="px-3 py-1 bg-emerald-600 text-white rounded text-sm">Export .env</button>
                    <button id="exportJson" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Export JSON</button>
                    <button id="refresh" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">Refresh</button>
                  </div>
                </div>

                <!-- Selected guild summary/actions -->
                <div id="selectedGuildCard" class="mb-4 hidden">
                  <div class="flex items-center justify-between p-3 border rounded bg-gray-50">
                    <div class="flex items-center gap-3">
                      <img id="selectedGuildIcon" src="" alt="Guild" class="w-8 h-8 rounded bg-gray-200 border" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'" />
                      <div>
                        <div id="selectedGuildName" class="font-medium">Guild</div>
                        <div class="text-xs text-gray-500">ID: <span id="selectedGuildId"></span> â€¢ <span id="selectedGuildStatus"></span></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button id="btnAuthorizeGuild" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Authorize</button>
                      <button id="btnDeauthorizeGuild" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm">Deauthorize</button>
                      <button id="btnClearGuildCache" class="px-3 py-1 bg-gray-100 rounded text-sm">Clear Cache</button>
                      <button id="btnDeleteGuild" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Delete Config</button>
                    </div>
                  </div>
                </div>

                <!-- Detected guilds moved to /admin/servers -->

                <div id="panelPrompts" class="space-y-3">
                  <h3 class="text-base font-semibold mb-2">Prompts</h3>
                  <div id="promptsList" class="space-y-3"></div>
                </div>

                <div id="panelSettings" class="mt-4 hidden space-y-4">
                  <h3 class="text-base font-semibold">Settings</h3>

                  <div id="guildConfigSection" class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex items-start justify-between flex-wrap gap-3 mb-4">
                      <div>
                        <h4 class="font-medium text-gray-900">Guild Configuration</h4>
                        <p class="text-sm text-gray-600">Adjust bot behaviour for the selected Discord server.</p>
                      </div>
                      <button type="button" id="refreshGuildConfig" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">Refresh</button>
                    </div>
                    <div id="guild-config-message" class="hidden mb-4 px-3 py-2 rounded text-sm"></div>
                    <div id="guild-config-empty" class="text-sm text-gray-500">
                      Select a Discord server from the scope sidebar to edit its configuration.
                    </div>
                    <form id="guild-settings-form" class="hidden space-y-4 lg:space-y-5">
                      <details id="guild-basic-section" class="bg-white border rounded-md p-4" open>
                        <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                          <span class="text-sm font-semibold text-gray-900">Basic Access &amp; Roles</span>
                          <span class="text-xs text-gray-500">Guild identity, authorization, and rate limits</span>
                        </summary>
                        <div class="mt-4 space-y-6">
                          <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6">
                            <div class="sm:col-span-3">
                              <label for="guild-id" class="block text-sm font-medium text-gray-700">Discord Server ID</label>
                              <input type="text" id="guild-id" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Discord server ID (numbers only)" />
                            </div>
                            <div class="sm:col-span-3">
                              <label for="guild-name" class="block text-sm font-medium text-gray-700">Server Name</label>
                              <input type="text" id="guild-name" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" />
                            </div>
                            <div class="sm:col-span-3">
                              <label for="summoner-role" class="block text-sm font-medium text-gray-700">Summoner Role (optional)</label>
                              <input type="text" id="summoner-role" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Role ID or name" />
                              <p class="mt-1 text-xs text-gray-500">Leave blank to allow everyone to summon.</p>
                            </div>
                            <div class="sm:col-span-3">
                              <label for="admin-roles" class="block text-sm font-medium text-gray-700">Admin Roles</label>
                              <input type="text" id="admin-roles" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Comma-separated role IDs or names" />
                            </div>
                            <div class="sm:col-span-3">
                              <div class="flex items-start">
                                <div class="flex items-center h-5">
                                  <input id="guild-authorized" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                                </div>
                                <div class="ml-3 text-sm">
                                  <label for="guild-authorized" class="font-medium text-gray-700">Authorize this server</label>
                                  <p class="text-gray-500">Enable the bot to respond in this Discord server.</p>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="border-t border-gray-200 pt-4">
                            <div class="flex items-center justify-between mb-3">
                              <h6 class="text-sm font-semibold text-gray-900">Rate Limiting</h6>
                              <label class="inline-flex items-center gap-2 text-xs font-medium text-gray-600">
                                <input id="rate-limit-enabled" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked />
                                Enable burst protection
                              </label>
                            </div>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6" id="rate-limit-inputs">
                              <div class="sm:col-span-3">
                                <label for="rate-limit-messages" class="block text-sm font-medium text-gray-700">Max Messages</label>
                                <input type="number" id="rate-limit-messages" min="1" max="100" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="5" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="rate-limit-interval" class="block text-sm font-medium text-gray-700">Interval (seconds)</label>
                                <input type="number" id="rate-limit-interval" min="1" max="3600" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="60" />
                              </div>
                            </div>
                          </div>
                        </div>
                      </details>

                      <details id="guild-features-section" class="bg-white border rounded-md p-4" open>
                        <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                          <span class="text-sm font-semibold text-gray-900">Features &amp; Modes</span>
                          <span class="text-xs text-gray-500">Toggle capabilities and customise emoji affordances</span>
                        </summary>
                        <div class="mt-4 space-y-6">
                          <section>
                            <h6 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Feature Flags</h6>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-3">
                          <div class="col-span-1">
                            <div class="flex items-start">
                              <div class="flex items-center h-5">
                                <input id="feature-breeding" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                              </div>
                              <div class="ml-3 text-sm">
                                <label for="feature-breeding" class="font-medium text-gray-700">Breeding</label>
                                <p class="text-gray-500">Enable avatar breeding</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-span-1">
                            <div class="flex items-start">
                              <div class="flex items-center h-5">
                                <input id="feature-combat" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                              </div>
                              <div class="ml-3 text-sm">
                                <label for="feature-combat" class="font-medium text-gray-700">Combat</label>
                                <p class="text-gray-500">Enable combat system</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-span-1">
                            <div class="flex items-start">
                              <div class="flex items-center h-5">
                                <input id="feature-item-creation" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                              </div>
                              <div class="ml-3 text-sm">
                                <label for="feature-item-creation" class="font-medium text-gray-700">Item Creation</label>
                                <p class="text-gray-500">Enable creating items</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-span-1">
                            <div class="flex items-start">
                              <div class="flex items-center h-5">
                                <input id="feature-moderation" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                              </div>
                              <div class="ml-3 text-sm">
                                <label for="feature-moderation" class="font-medium text-gray-700">Moderation</label>
                                <p class="text-gray-500">Flag risky content automatically</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </section>
                          <section class="border-t border-gray-200 pt-4">
                            <h6 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Avatar Modes</h6>
                            <p class="text-sm text-gray-500 mb-3">Enable the avatar creation channels this server should support.</p>
                            <div class="space-y-3">
                              <label class="flex items-start gap-3 text-sm">
                                <input id="avatar-mode-free" type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                <span>
                                  <span class="block font-medium text-gray-700">Summoned &amp; bred avatars</span>
                                  <span class="text-gray-500">Allow free-form avatar creation via summon and breed commands.</span>
                                </span>
                              </label>
                              <label class="flex items-start gap-3 text-sm">
                                <input id="avatar-mode-on-chain" type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                <span>
                                  <span class="block font-medium text-gray-700">On-chain avatars</span>
                                  <span class="text-gray-500">Auto-generate avatars from wallet activity and token holdings.</span>
                                </span>
                              </label>
                              <label class="flex items-start gap-3 text-sm">
                                <input id="avatar-mode-collection" type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                <span>
                                  <span class="block font-medium text-gray-700">Collection avatars</span>
                                  <span class="text-gray-500">Sync avatars from registered NFT collections.</span>
                                </span>
                              </label>
                              <label class="flex items-start gap-3 text-sm">
                                <input id="avatar-mode-pure-model" type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                <span>
                                  <span class="block font-medium text-gray-700">Pure model avatars</span>
                                  <span class="text-gray-500">Keep personas limited to curated model templates.</span>
                                </span>
                              </label>
                            </div>
                          </section>
                          <section class="border-t border-gray-200 pt-4">
                            <div class="flex items-center justify-between mb-3">
                              <h6 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Tool Emojis</h6>
                              <span class="text-xs text-gray-500">Shown beside the slash commands in Discord</span>
                            </div>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6" id="tool-emoji-grid">
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-summon" class="block text-sm font-medium text-gray-700">Summon</label>
                                <input type="text" id="tool-emoji-summon" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ”®" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-breed" class="block text-sm font-medium text-gray-700">Breed</label>
                                <input type="text" id="tool-emoji-breed" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ¹" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-attack" class="block text-sm font-medium text-gray-700">Attack</label>
                                <input type="text" id="tool-emoji-attack" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="âš”ï¸" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-defend" class="block text-sm font-medium text-gray-700">Defend</label>
                                <input type="text" id="tool-emoji-defend" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ›¡ï¸" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-move" class="block text-sm font-medium text-gray-700">Move</label>
                                <input type="text" id="tool-emoji-move" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ—ºï¸" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-remember" class="block text-sm font-medium text-gray-700">Remember</label>
                                <input type="text" id="tool-emoji-remember" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ§ " />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-create" class="block text-sm font-medium text-gray-700">Create</label>
                                <input type="text" id="tool-emoji-create" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="âœ¨" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-x" class="block text-sm font-medium text-gray-700">X Command</label>
                                <input type="text" id="tool-emoji-x" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="âŒ" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-item" class="block text-sm font-medium text-gray-700">Item</label>
                                <input type="text" id="tool-emoji-item" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸŽ" />
                              </div>
                              <div class="sm:col-span-3">
                                <label for="tool-emoji-respond" class="block text-sm font-medium text-gray-700">Respond</label>
                                <input type="text" id="tool-emoji-respond" list="tool-emoji-options" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="ðŸ’¬" />
                              </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Pick from the preset list or paste any emoji â€” leave blank to inherit the global default.</p>
                            <datalist id="tool-emoji-options">
                              <option value="ðŸ”®"></option>
                              <option value="ðŸ¹"></option>
                              <option value="âš”ï¸"></option>
                              <option value="ðŸ›¡ï¸"></option>
                              <option value="ðŸ—ºï¸"></option>
                              <option value="ðŸ§ "></option>
                              <option value="âœ¨"></option>
                              <option value="âŒ"></option>
                              <option value="ðŸŽ"></option>
                              <option value="ðŸ’¬"></option>
                              <option value="ðŸ”¥"></option>
                              <option value="ðŸŒŸ"></option>
                            </datalist>
                          </section>
                          <label class="flex items-start gap-3 text-sm border-t border-gray-200 pt-4">
                            <input id="feature-view-details" type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                            <span>
                              <span class="block font-medium text-gray-700">View Details Link</span>
                              <span class="text-gray-500">Show avatar "View Details" link in embeds.</span>
                            </span>
                          </label>
                        </div>
                      </details>

                      <details id="guild-prompts-section" class="bg-white border rounded-md p-4">
                        <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                          <span class="text-sm font-semibold text-gray-900">Persona Prompts</span>
                          <span class="text-xs text-gray-500">Optional overrides for summon, combat, and breeding flows</span>
                        </summary>
                        <div class="mt-4 space-y-4">
                          <div>
                            <label for="intro-prompt" class="block text-sm font-medium text-gray-700">Intro Prompt</label>
                            <textarea id="intro-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="You are now conversing with {avatar_name}, a unique AI character with its own personality and abilities."></textarea>
                          </div>
                          <div>
                            <label for="summon-prompt" class="block text-sm font-medium text-gray-700">Summon Prompt</label>
                            <textarea id="summon-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="You are {avatar_name}, responding to being summoned by {user_name}."></textarea>
                          </div>
                          <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
                            <div>
                              <label for="attack-prompt" class="block text-sm font-medium text-gray-700">Attack Prompt</label>
                              <textarea id="attack-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="You are {avatar_name}, attacking {target_name} with your abilities."></textarea>
                            </div>
                            <div>
                              <label for="defend-prompt" class="block text-sm font-medium text-gray-700">Defend Prompt</label>
                              <textarea id="defend-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="You are {avatar_name}, defending against an attack."></textarea>
                            </div>
                          </div>
                          <div>
                            <label for="breed-prompt" class="block text-sm font-medium text-gray-700">Breed Prompt</label>
                            <textarea id="breed-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="You are {avatar_name}, breeding with {target_name} to create a new entity."></textarea>
                          </div>
                        </div>
                      </details>

                      <details id="guild-camera-section" class="bg-white border rounded-md p-4">
                        <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                          <span class="text-sm font-semibold text-gray-900">Camera Configuration</span>
                          <span class="text-xs text-gray-500">Customize the style of photos taken in this server</span>
                        </summary>
                        <div class="mt-4 space-y-4">
                          <div>
                            <label for="camera-style-prompt" class="block text-sm font-medium text-gray-700">Camera Style Prompt</label>
                            <textarea id="camera-style-prompt" rows="2" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="cinematic anime style, 16:9, soft lighting, detailed background, cohesive composition, no UI or watermark"></textarea>
                            <p class="mt-1 text-xs text-gray-500">This style is appended to the scene description generated by the Director Mode.</p>
                          </div>
                        </div>
                      </details>

                      <details id="guild-tribe-section" class="bg-white border rounded-md p-4" open>
                        <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                          <span class="text-sm font-semibold text-gray-900">Avatar Tribe Restrictions</span>
                          <span class="text-xs text-gray-500">Control which emoji tribes can appear globally or per-channel</span>
                        </summary>
                        <div class="mt-4 space-y-4">
                          <div>
                            <label for="avatar-tribe-mode" class="block text-sm font-medium text-gray-700">Default Restriction Mode</label>
                            <select id="avatar-tribe-mode" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                              <option value="permit">Permit All (only listed emojis forbidden)</option>
                              <option value="forbid">Forbid All (only listed emojis permitted)</option>
                            </select>
                          </div>
                          <div>
                            <label for="avatar-tribe-exceptions" class="block text-sm font-medium text-gray-700">Exceptions (comma-separated emojis)</label>
                            <input type="text" id="avatar-tribe-exceptions" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="ðŸ‰, ðŸ¦„" />
                            <p class="mt-1 text-xs text-gray-500">Tip: paste any emoji and press enter to separate items quickly.</p>
                          </div>
                          <div>
                            <div class="flex items-center justify-between mb-2">
                              <h6 class="text-sm font-medium text-gray-700">Channel Overrides</h6>
                              <button type="button" id="add-avatar-tribe-override" class="inline-flex items-center gap-1 px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                + Add Override
                              </button>
                            </div>
                            <div id="avatar-tribe-restrictions-channels" class="space-y-2"></div>
                            <p class="text-xs text-gray-500">Overrides let you block or permit specific tribes in individual channels.</p>
                          </div>
                        </div>
                      </details>

                      <div class="flex justify-end pt-2">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save Settings</button>
                      </div>
                    </form>

                    <div id="detected-guilds-section" class="mt-8 hidden">
                      <div class="flex justify-between items-center mb-3" id="detected-guilds-header">
                        <div class="flex items-center space-x-2">
                          <h5 class="text-sm font-semibold text-gray-900">Detected Servers</h5>
                          <span id="detected-guilds-count" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">0</span>
                        </div>
                        <button id="refresh-detected-guilds" class="text-sm px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded flex items-center gap-1 transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.433a.75.75 0 000-1.5H3.989a.75.75 0 00-.75.75v4.242a.75.75 0 001.5 0v-2.43l.31.31a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm1.23-3.723a.75.75 0 00.219-.53V2.929a.75.75 0 00-1.5 0V5.36l-.31-.31A7 7 0 003.239 8.188a.75.75 0 101.448.389A5.5 5.5 0 0113.89 6.11l.311.31h-2.432a.75.75 0 000 1.5h4.243a.75.75 0 00.53-.219z" clip-rule="evenodd" />
                          </svg>
                          Refresh
                        </button>
                      </div>
                      <div id="detected-guilds-content">
                        <p class="text-sm text-gray-600 mb-4">The following Discord servers have the bot installed but are not yet authorized:</p>
                        <div id="detected-guilds-container" class="space-y-3"></div>
                        <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-white">
                          <h6 class="font-medium mb-2 text-gray-900">Add Server Manually</h6>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                              <label for="manual-guild-id" class="block text-sm font-medium text-gray-700 mb-1">Server ID</label>
                              <input type="text" id="manual-guild-id" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter Discord server ID" />
                            </div>
                            <div>
                              <label for="manual-guild-name" class="block text-sm font-medium text-gray-700 mb-1">Server Name</label>
                              <input type="text" id="manual-guild-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter server name" />
                            </div>
                          </div>
                          <button id="manual-whitelist-button" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Whitelist Server</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Replicate Configuration Section -->
                  <div id="replicateConfig" class="border rounded-lg p-4 mb-4 bg-gray-50">
                    <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
                      <div>
                        <h4 class="font-medium text-gray-900">Replicate Image Generation</h4>
                        <p class="text-sm text-gray-600">Manage Flux LoRA settings and generate sample images with your Replicate token.</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button type="button" id="resetReplicateConfig" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">Reset</button>
                        <button type="button" id="saveReplicateConfig" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Save</button>
                      </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateTokenInput">Replicate API Token</label>
                        <div class="flex gap-2">
                          <input type="password" id="replicateTokenInput" autocomplete="off" placeholder="Enter new token to replace existing" class="flex-1 px-3 py-2 border rounded text-sm" />
                          <button type="button" id="clearReplicateToken" class="px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">Clear</button>
                        </div>
                        <p id="replicateTokenStatus" class="text-xs text-gray-500 mt-1">Token status unknown.</p>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateBaseModelInput">Flux Base Model</label>
                        <input type="text" id="replicateBaseModelInput" class="w-full px-3 py-2 border rounded text-sm font-mono" placeholder="black-forest-labs/flux-dev-lora" />
                        <p class="text-xs text-gray-500 mt-1">Defaults to <code>black-forest-labs/flux-dev-lora</code> if left empty.</p>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateLoraWeightsInput">LoRA Weights</label>
                        <input type="text" id="replicateLoraWeightsInput" class="w-full px-3 py-2 border rounded text-sm font-mono" placeholder="your-user/weights:version" />
                        <p class="text-xs text-gray-500 mt-1">Used as the <code>lora_weights</code> parameter when invoking the Flux LoRA model.</p>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateLoraTriggerInput">LoRA Trigger Word</label>
                        <input type="text" id="replicateLoraTriggerInput" class="w-full px-3 py-2 border rounded text-sm" placeholder="e.g. MRQ" />
                        <p class="text-xs text-gray-500 mt-1">Optional keyword appended to prompts when generating with this LoRA.</p>
                      </div>
                    </div>
                    <div id="replicateConfigStatus" class="hidden mt-3">
                      <div class="p-2 rounded text-sm"></div>
                    </div>

                    <div class="border-t border-gray-200 mt-6 pt-4">
                      <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
                        <div>
                          <h5 class="font-medium text-gray-900">Sample Image Preview</h5>
                          <p class="text-sm text-gray-600">Use the current configuration or override values below to test image generation.</p>
                        </div>
                        <button type="button" id="generateReplicateSample" class="px-3 py-1 bg-teal-600 text-white rounded text-sm hover:bg-teal-700">Generate Sample</button>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="space-y-3">
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateSamplePromptInput">Sample Prompt</label>
                            <textarea id="replicateSamplePromptInput" rows="4" class="w-full px-3 py-2 border rounded text-sm">A cozy avatar portrait bathed in warm tavern light, painterly watercolor finish.</textarea>
                          </div>
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="replicateSampleAspectInput">Aspect Ratio</label>
                            <input type="text" id="replicateSampleAspectInput" value="1:1" class="w-full px-3 py-2 border rounded text-sm" />
                            <p class="text-xs text-gray-500 mt-1">Example values: <code>1:1</code>, <code>3:4</code>, <code>16:9</code>.</p>
                          </div>
                        </div>
                        <div class="flex flex-col gap-3">
                          <div id="replicateSamplePreview" class="hidden border rounded-lg overflow-hidden bg-white">
                            <img id="replicateSampleImage" src="" alt="Replicate sample preview" class="w-full object-cover" />
                          </div>
                          <p id="replicateSampleEmpty" class="text-sm text-gray-500">Generate a sample to preview the latest settings.</p>
                        </div>
                      </div>
                      <div id="replicateSampleStatus" class="hidden mt-3">
                        <div class="p-2 rounded text-sm"></div>
                      </div>
                    </div>
                  </div>
                  <!-- Wallet Avatar Preferences Section -->
                  <div id="walletAvatarPreferences" class="border rounded-lg p-4 mb-4 bg-gray-50">
                    <div class="flex items-center justify-between mb-4">
                      <div>
                        <h4 class="font-medium text-gray-900">Wallet Avatar Preferences</h4>
                        <p class="text-sm text-gray-600">Configure global defaults and per-token overrides for wallet avatar automation.</p>
                      </div>
                      <button id="addWalletAvatarOverride" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Add Token Override</button>
                    </div>
                    <div class="space-y-3">
                      <div id="walletAvatarDefaults"></div>
                      <div>
                        <h5 class="text-sm font-semibold text-gray-800 mb-2">Token Overrides</h5>
                        <div id="walletAvatarOverrides" class="space-y-2"></div>
                      </div>
                      <div id="walletAvatarEditor" class="hidden"></div>
                    </div>
                    <div id="walletAvatarStatus" class="hidden mt-3">
                      <div class="p-2 rounded text-sm"></div>
                    </div>
                  </div>
                  
                  <details id="advanced-settings-block" class="bg-white border rounded-md p-4">
                    <summary class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 cursor-pointer">
                      <span class="text-sm font-semibold text-gray-900">Advanced Key Overrides</span>
                      <span class="text-xs text-gray-500">Directly edit raw settings keys (use with caution)</span>
                    </summary>
                    <div id="settingsList" class="mt-4 space-y-3"></div>
                  </details>
                </div>

                <div id="panelPayments" class="mt-4 hidden">
                  <h3 class="text-base font-semibold mb-2">Payment Configuration</h3>
                  <p class="text-sm text-gray-600 mb-4">Configure Coinbase CDP x402 payment integration for autonomous agent transactions.</p>
                  
                  <!-- x402 Configuration -->
                  <div class="border rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="font-medium text-gray-900">x402 Payment Protocol</h4>
                      <div class="flex items-center gap-2">
                        <span id="x402-status" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700">Not Configured</span>
                        <button id="testX402Connection" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Test Connection</button>
                      </div>
                    </div>
                    
                    <div class="space-y-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CDP API Key ID</label>
                        <input id="cdpApiKeyId" type="text" 
                          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" 
                          class="w-full px-3 py-2 border rounded text-sm font-mono"
                        />
                        <p class="text-xs text-gray-500 mt-1">Copy the API Key ID (UUID format) from your CDP portal</p>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CDP API Key Secret</label>
                        <textarea id="cdpApiKeySecret" rows="8" 
                          placeholder="Paste your API key secret here&#10;&#10;Ed25519 format (recommended):&#10;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==&#10;&#10;OR ECDSA PEM format:&#10;-----BEGIN EC PRIVATE KEY-----&#10;MHcCAQEEI...&#10;-----END EC PRIVATE KEY-----"
                          class="w-full px-3 py-2 border rounded text-sm font-mono"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                          Paste the <strong>complete</strong> API key secret from CDP portal. 
                          Ed25519 keys end with <code>==</code>, ECDSA keys have BEGIN/END markers.
                        </p>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Seller Address (Base/Ethereum)</label>
                        <input id="sellerAddress" type="text" 
                          placeholder="0x..." 
                          class="w-full px-3 py-2 border rounded text-sm font-mono"
                        />
                        <p class="text-xs text-gray-500 mt-1">Wallet address to receive payments (0x...)</p>
                      </div>
                      
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Default Network</label>
                          <select id="defaultNetwork" class="w-full px-3 py-2 border rounded text-sm">
                            <option value="base">Base (Mainnet)</option>
                            <option value="base-sepolia">Base Sepolia (Testnet)</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="solana">Solana</option>
                          </select>
                        </div>
                        
                        <div>
                          <label class="flex items-center gap-2 mt-6">
                            <input id="enableTestnet" type="checkbox" class="rounded" />
                            <span class="text-sm text-gray-700">Enable Testnet Mode</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Agent Wallet Configuration -->
                  <div class="border rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-gray-900 mb-3">Agent Wallet Configuration</h4>
                    
                    <div class="space-y-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Wallet Encryption Key</label>
                        <div class="flex gap-2">
                          <input id="walletEncryptionKey" type="password" 
                            placeholder="32+ character encryption key" 
                            class="flex-1 px-3 py-2 border rounded text-sm font-mono"
                          />
                          <button id="generateEncryptionKey" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">Generate</button>
                          <button id="toggleEncryptionKeyVisibility" class="px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">Show</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Used to encrypt agent private keys in database (AES-256-GCM)</p>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Default Daily Limit (USDC)</label>
                        <input id="defaultDailyLimit" type="number" step="0.01" 
                          placeholder="100.00" 
                          class="w-full px-3 py-2 border rounded text-sm"
                        />
                        <p class="text-xs text-gray-500 mt-1">Default spending limit per agent per day (in USDC)</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Save Button -->
                  <div class="flex justify-end gap-2">
                    <button id="resetPaymentConfig" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Reset</button>
                    <button id="savePaymentConfig" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Configuration</button>
                  </div>
                  
                  <!-- Status Messages -->
                  <div id="paymentConfigStatus" class="mt-4 hidden">
                    <div class="p-3 rounded border"></div>
                  </div>
                </div>

                <div id="panelSecrets" class="mt-4 hidden">
                  <h3 class="text-base font-semibold mb-2">Secrets</h3>
                  <div class="mb-3">
                    <textarea id="envText" rows="3" class="w-full border rounded p-2 text-sm" placeholder="PASTE .env CONTENT HERE\nOPENROUTER_API_KEY=...\n..."></textarea>
                    <div class="mt-2 flex gap-2">
                      <button id="importEnv" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Import .env</button>
                      <span id="importStatus" class="text-sm text-gray-500"></span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Note: Secret values shown/exported here are masked for safety.</p>
                  </div>
                  <div id="secretsList" class="space-y-3"></div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script type="module" src="/js/admin/admin-bootstrap.js"></script>
    <script type="module" src="/js/admin-settings.js"></script>
  </body>
</html>
