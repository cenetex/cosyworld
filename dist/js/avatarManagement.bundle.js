document.addEventListener("DOMContentLoaded",(()=>{const e={currentPage:1,pageSize:20,totalAvatars:0,currentStatusFilter:"all",currentModelFilter:"all",currentSearch:""};!async function(){const t=document.getElementById("model-filter"),n=document.getElementById("avatar-model"),r=document.createElement("option");r.textContent="Loading...",r.disabled=!0,r.selected=!0,t.appendChild(r),n.appendChild(r.cloneNode(!0));try{const r=await fetch("/api/models/config");if(!r.ok)throw new Error(`HTTP error ${r.status}`);const o=await r.json();t.innerHTML="",n.innerHTML="";const d=document.createElement("option");d.value="all",d.textContent="All Models",t.appendChild(d),Object.keys(o).forEach((e=>{const a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a);const r=document.createElement("option");r.value=e,r.textContent=e,n.appendChild(r)})),t.addEventListener("change",(()=>{e.currentModelFilter=t.value,e.currentPage=1,a()}))}catch(e){console.error("Error loading models:",e),t.innerHTML="<option disabled selected>Error loading models</option>",n.innerHTML="<option disabled selected>Error loading models</option>"}}();const t={statusFilter:document.getElementById("status-filter"),modelFilter:document.getElementById("model-filter"),avatarsBody:document.getElementById("avatars-body"),paginationInfo:document.getElementById("pagination-info"),prevPageBtn:document.getElementById("prev-page"),nextPageBtn:document.getElementById("next-page"),avatarFilter:document.getElementById("avatar-filter"),avatarSearch:document.getElementById("avatar-search"),newAvatarBtn:document.getElementById("new-avatar"),avatarModal:document.getElementById("avatar-modal"),closeModal:document.getElementById("close-modal"),cancelEdit:document.getElementById("cancel-edit"),deleteAvatarBtn:document.getElementById("delete-avatar"),avatarForm:document.getElementById("avatar-form"),modalTitle:document.getElementById("modal-title"),imagePreview:document.getElementById("avatar-image-preview"),imageUrlInput:document.getElementById("avatar-image-url"),saveBtn:document.getElementById("save-avatar")};async function a(){try{if(e.currentSearch.trim().length>=2)return;const a=new URLSearchParams({page:e.currentPage,limit:e.pageSize,status:e.currentStatusFilter,model:e.currentModelFilter}),o=await fetch(`/api/avatars?${a}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const d=await o.json();if(d.error)throw new Error(d.error);const i=d.avatars||[];e.totalAvatars=d.total||0,0===i.length?t.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>':r(i),n(e.totalAvatars,d.page||1,d.limit||e.pageSize)}catch(e){console.error("Error loading avatars:",e),t.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">Failed to load avatars</td></tr>'}}function n(e,t,a){const n=(t-1)*a+1,r=Math.min(t*a,e);document.getElementById("paginationInfo").textContent=`Showing ${n}-${r} of ${e} avatars`}function r(e){0!==e.length?(t.avatarsBody.innerHTML=e.map(o).join(""),document.querySelectorAll(".edit-avatar").forEach((e=>{e.addEventListener("click",(()=>async function(e){try{t.avatarModal.classList.remove("hidden"),t.modalTitle.textContent="Loading Avatar Data...";const a=await fetch(`/api/admin/avatars/${e}`);if(!a.ok)throw new Error(`HTTP error ${a.status}`);const n=await a.json();t.modalTitle.textContent=`Edit Avatar: ${n.name}`,t.avatarForm.dataset.avatarId=e,t.deleteAvatarBtn.classList.remove("hidden"),i(n)}catch(e){console.error("Error fetching avatar:",e),c(),m("Failed to load avatar details","error")}}(e.dataset.avatarId)))})),document.querySelectorAll(".delete-avatar").forEach((e=>{e.addEventListener("click",(()=>{confirm("Are you sure you want to delete this avatar?")&&deleteAvatar(e.dataset.avatarId)}))}))):t.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>'}function o(e){return`\n      <tr>\n        <td class="px-6 py-4 whitespace-nowrap">\n          <img class="h-10 w-10 rounded-full object-cover" src="${e.thumbnailUrl||e.imageUrl||"/default-avatar.png"}" alt="${e.name||"Avatar"}">\n        </td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.name||"Unnamed"} ${e.emoji||""}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e._id}</td>\n        <td class="px-6 py-4 whitespace-nowrap">\n          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t=e.status,{alive:"bg-green-100 text-green-800",dead:"bg-red-100 text-red-800",inactive:"bg-gray-100 text-gray-800"}[t]||"bg-gray-100 text-gray-800"}">\n            ${e.status||"Unknown"}\n          </span>\n        </td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.model||"Not specified"}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${function(e){if(!e)return"Unknown";const t=new Date(e);return isNaN(t.getTime())?"Invalid date":t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}(e.createdAt)}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm">\n          <button data-avatar-id="${e._id}" class="edit-avatar text-indigo-600 hover:text-indigo-900">Edit</button>\n          <button data-avatar-id="${e._id}" class="delete-avatar text-red-600 hover:text-red-900 ml-2">Delete</button>\n        </td>\n      </tr>\n    `;var t}function n(){const a=(e.currentPage-1)*e.pageSize+1,n=Math.min(e.currentPage*e.pageSize,e.totalAvatars);t.paginationInfo.textContent=`Showing ${a}-${n} of ${e.totalAvatars} avatars`,t.prevPageBtn.disabled=1===e.currentPage,t.nextPageBtn.disabled=n>=e.totalAvatars}function d(){t.avatarForm.dataset.avatarId="",t.modalTitle.textContent="Create New Avatar",t.deleteAvatarBtn.classList.add("hidden"),t.avatarForm.reset(),t.imagePreview.src="",t.imagePreview.classList.add("hidden"),t.imageUrlInput.value="",t.avatarModal.classList.remove("hidden")}function i(e){document.getElementById("avatar-name").value=e.name||"",document.getElementById("avatar-status").value=e.status||"alive",document.getElementById("avatar-model").value=e.model||"gemini-2.0-flash",document.getElementById("avatar-emoji").value=e.emoji||"",document.getElementById("avatar-description").value=e.description||"",document.getElementById("avatar-personality").value=e.personality||"",t.imageUrlInput.value=e.imageUrl||"",t.imagePreview.src=e.imageUrl||"",t.imagePreview.classList.toggle("hidden",!e.imageUrl)}async function s(e){e.preventDefault();const n=t.avatarForm.dataset.avatarId,r=n?"PUT":"POST",o=n?`/api/admin/avatars/${n}`:"/api/admin/avatars",d=new FormData(t.avatarForm);t.saveBtn.disabled=!0,t.saveBtn.textContent="Saving...";try{const e=await fetch(o,{method:r,headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(d))});if(!e.ok)throw new Error(`HTTP error ${e.status}`);let t;if(!n)return c(),a(),void m("Avatar created successfully");{const e=await fetch(`/api/admin/avatars/${n}`);t=await e.json(),i(t),m("Avatar updated successfully")}a()}catch(e){console.error("Error saving avatar:",e),m("Failed to save avatar","error")}finally{t.saveBtn.disabled=!1,t.saveBtn.textContent="Save Changes"}}async function l(){const e=t.avatarForm.dataset.avatarId;if(e&&confirm("Are you sure you want to delete this avatar?"))try{const t=await fetch(`/api/admin/avatars/${e}`,{method:"DELETE"});if(!t.ok)throw new Error(`HTTP error ${t.status}`);c(),a(),m("Avatar deleted successfully")}catch(e){console.error("Error deleting avatar:",e),m("Failed to delete avatar","error")}}function c(){t.avatarModal.classList.add("hidden")}function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";const a=document.createElement("div");a.className="fixed bottom-4 right-4 z-50";const n=document.createElement("div");n.className=`p-3 rounded shadow-lg ${"success"===t?"bg-green-500":"bg-red-500"} text-white`,n.textContent=e,a.appendChild(n),document.body.appendChild(a),setTimeout((()=>a.remove()),3e3)}function v(e,t){let a;return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];clearTimeout(a),a=setTimeout((()=>e.apply(this,r)),t)}}a(),function(){t.prevPageBtn.addEventListener("click",(()=>{e.currentPage>1&&(e.currentPage--,a())})),t.nextPageBtn.addEventListener("click",(()=>{e.currentPage*e.pageSize<e.totalAvatars&&(e.currentPage++,a())})),t.statusFilter.addEventListener("change",(()=>{e.currentStatusFilter=t.statusFilter.value,e.currentPage=1,a()})),t.avatarSearch.addEventListener("input",v((()=>{e.currentSearch=t.avatarSearch.value,e.currentPage=1,a()}),300)),t.newAvatarBtn.addEventListener("click",d),t.closeModal.addEventListener("click",c),t.cancelEdit.addEventListener("click",c),document.getElementById("preview-prompt").addEventListener("click",(async()=>{const e=t.avatarForm.dataset.avatarId;if(!e)return void m("Please save the avatar first to preview prompts","error");const a=document.getElementById("prompt-preview-container"),n=document.getElementById("prompt-preview-content");try{n.innerHTML="Loading preview...",a.classList.remove("hidden");const t=await fetch(`/api/admin/avatars/${e}/preview-prompt`);if(!t.ok)throw new Error(`HTTP error ${t.status}`);const r=await t.json();n.innerHTML=r.prompt||"No prompt preview available"}catch(e){console.error("Error fetching prompt preview:",e),n.innerHTML=`Error loading preview: ${e.message}`}})),document.addEventListener("keydown",(e=>{"Escape"!==e.key||t.avatarModal.classList.contains("hidden")||c()})),t.avatarForm.addEventListener("submit",s),t.deleteAvatarBtn.addEventListener("click",l);const n=document.createElement("input");n.type="file",n.accept="image/*",n.style.display="none",document.body.appendChild(n);const r=document.createElement("button");r.textContent="Upload Image",r.className="ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",t.imageUrlInput.parentNode.appendChild(r),r.addEventListener("click",(()=>{n.click()})),n.addEventListener("change",(async e=>{const a=e.target.files[0];if(!a)return;const o=new FormData;o.append("image",a);try{r.disabled=!0,r.textContent="Uploading...";const e=await fetch("/api/admin/upload-image",{method:"POST",body:o});if(!e.ok)throw new Error(`Upload failed: ${e.statusText}`);const a=await e.json();t.imageUrlInput.value=a.url,t.imagePreview.src=a.url,t.imagePreview.classList.remove("hidden"),m("Image uploaded successfully")}catch(e){console.error("Upload error:",e),m("Failed to upload image","error")}finally{r.disabled=!1,r.textContent="Upload Image",n.value=""}})),t.imageUrlInput.addEventListener("input",(()=>{const e=t.imageUrlInput.value;t.imagePreview.src=e,t.imagePreview.classList.toggle("hidden",!e)}))}(),t.avatarSearch.addEventListener("input",v((()=>{const n=t.avatarSearch.value.trim();e.currentSearch=n,n.length>=2?async function(e){try{const a=await fetch(`/api/avatars/search?name=${encodeURIComponent(e)}`);if(!a.ok)throw new Error(`HTTP error ${a.status}`);const n=(await a.json()).avatars||[];0===n.length?t.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>':r(n)}catch(e){console.error("Error searching avatars:",e),t.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">Failed to search avatars</td></tr>'}}(n):(e.currentPage=1,e.currentSearch="",a())}),300))}));